<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<h3>Как редактировать *.m3d/*.a3d</h3>
<ol>
  <li>Откройте modes/3d/m3d_to_obj.cfg в любом текстовом редакторе. Замените значение опции source_dir на путь к папке "data" Вангеров.</li>
  <li>Запустите modes/3d/m3d_to_obj.bat.</li>
  <li>Теперь папка modes/3d/io_obj содержит *.obj файлы с моделями из Вангеров и их можно редактировать. Смотрите docs/common/3d/3d_models.ods. Если вы хотите отредактировать bound модели, колеса или точки крепления оружия, смотрите ниже.</li>
  <li>Запустите modes/3d/obj_to_m3d.bat.</li>
  <li>Теперь папка modes/3d/out_m3d содержит отредактированные *.m3d/*.a3d файлы. Вы можете скопировать содержимое этой папки в папку "data" Вангеров, чтобы заменить оригинальные модели на отредактированные. Стоит создать резервную копию оригинальных данных перед тем, как это делать.</li>
</ol>

<h3>Более подробно</h3>
<ul>
  <li>
    <p>*.m3d/*.a3d файлы состоят из нескольких моделей. При  конвертации *.m3d/*.a3d в *.obj, для каждой из этих моделей создается файл *.obj.</p>
    <ul>
      <li>
        <p>У *.m3d всегда есть главная модель и ее bound модель.</p>
        <ul>
          <li>Главная модель. Пример имени obj файла: m5_main.obj, где "m5" - имя *.m3d файла.</li>
          <li>Bound модель. Пример имени obj файла: m5_main_bound.obj, где "m5" - имя *.m3d файла.</li>
        </ul>
        <p>Файл *.m3d мехоса может иметь несколько моделей обломков.</p>
        <ul>
          <li>Модель обломка. Пример имени obj файла: m5_debris_6.obj, где "m5" - имя *.m3d файла и "6" - порядковый номер обломка.</li>
          <li>Bound модель обломка. Пример имени obj файла: m5_debris_bound_6.obj, где "m5" - имя *.m3d файла и "6" - порядковый номер обломка.</li>
        </ul>
        <p>Нумерация моделей обломков должна начинаться с 1. Номера нельзя пропускать. Если есть обломки 1 и 3, то должен присутствовать и обломок 2. У каждой модели обломка должна быть своя bound модель.</p>
       </li>
      <li>
        <p>В файле *.a3d содержатся несколько моделей. Каждая модель - кадр анимации. Например: a2_4.obj, где "a2" - имя *.a3d файла и "4" - кадр анимации. Нумерация должна начинаться с 1. Номера нельзя пропускать. Если есть кадры 1 и 3, то должен присутствовать и кадр 2.</p>
      </li>
    </ul>
  </li>
  <li><p>Все модели, кроме bound моделей, должны иметь 3 вертекса на полигон.</p></li>
  <li><p>Центр bounding box обычной модели должен совпадать с точкой начала координат. Bounding box - виртуальный и не является bound моделью. Модель центра масс, точки крепления оружия, поворотные и призрачные колеса не должны быть частью модели, которая используется при расчете bounding box.</p></li>
  <li>
    <p>При конвертации из *.m3d/*.a3d в *.obj, модель скалируется используя параметр scale_size из конфигурационных файлов. При конвертации обратно в *.m3d/*.a3d, новый scale_size рассчитывается и используется при генерации моделей и конфигурационных файлов.</p>
    <ul>
      <li>Параметр rmax - это дистанция между самой дальней точкой и центром модели. Значение rmax *.m3d/*.a3d рассчитывается как самое большое значение rmax среди всех моделей, которые не являются bound моделями. При расчете rmax мехоса прикрепляемое оружие тоже учитывается.</li>
      <li>Если у вновь созданной или отредактированной модели оружия значение rmax больше, чем у старых моделей оружия, она не будет правильно рендериться со старыми *.m3d файлами мехосов. В таком случае нужно использовать *.m3d файлы мехосов, сгенерированные с *.m3d файлом нового оружия.</li>
      <li>Существует лимит рендеринга scale_size, который зависит от приближения камеры и высоты объекта над точкой отсчета. Если, например, scale_size модели равен 1, а лимит scale_size равен 0.5, то модель будет рендериться со scale_size 0.5. Таблица ниже показывает лимит scale_size для разных ситуаций. Значение rmax, при котором конвертер назначает определенный scale_size, указано в скобках.</li>
      <table border=1>
        <tr>
          <th>Высота (z)\Приближение камеры</th>
          <th>Максимальное</th>
          <th>Без приближения</th>
        </tr>
          <th>Максимальная (450)</th>
          <td>0.280273 (34.473579)</td>
          <td>0.560547 (68.947281)</td>
        <tr>
          <th>Жабля (440)</th>
          <td>0.285156 (35.074188)</td>
          <td>0.570313 (70.148499)</td>
        </tr>
        <tr>
          <th>Вертолет (354)</th>
          <td>0.327148 (40.239204)</td>
          <td>0.654297 (80.478531)</td>
        </tr>
        <tr>
          <th>Гора на границе (255)</th>
          <td>0.375977 (46.245171)</td>
          <td>0.751953 (92.490219)</td>
        </tr>
        <tr>
          <th>Рыба (68)</th>
          <td>0.466797 (57.416031)</td>
          <td>0.933594 (114.832062)</td>
        </tr>
        <tr>
          <th>Минимальная (0)</th>
          <td>0.5 (61.5)</td>
          <td>1 (123)</td>
        </tr>
      </table>
    </ul>
  </li>
  <li>
    <p>Материалы полигонов используются, чтобы определить цвета в игре для этих полигонов и обозначить специальные полигоны.</p>
    <p>Игра использует палитру из 256 цветов. Каждому материалу назначены несколько цветов - от темного к светлому. Последний цвет в палитре никогда не используется, поэтому материал body_green, например, имеет на 1 цвет меньше.</p>
    <p>Цвета в диапазоне от 0 до 127 различаются в каждом мире/цикле и используются ландшафтом.</p>
    <p>Цвета в диапазоне от 88 до 119 меняются каждую секунду.</p>
    <p>Цвета материала определяются параметрами offset и shift.</p>
    <ul>
      <li>Offset указывает позицию начального цвета.</li>
      <li>
        <p>Shift определяет количество цветов. Точная формула: 1 + 123/2^shift. Результат округляется к меньшему.</p>
        <table border=1>
          <tr>
            <th>Shift</th>
            <th>Цветов на материал</th>
          </tr>
          <tr>
            <td>7</td>
            <td>1</td>
          </tr>
          <tr>
            <td>6</td>
            <td>2</td>
          </tr>
          <tr>
            <td>5</td>
            <td>4</td>
          </tr>
          <tr>
            <td>4</td>
            <td>8</td>
          </tr>
          <tr>
            <td>3</td>
            <td>16</td>
          </tr>
          <tr>
            <td>2</td>
            <td>31</td>
          </tr>
          <tr>
            <td>1</td>
            <td>62</td>
          </tr>
          <tr>
            <td>0</td>
            <td>124</td>
          </tr>
        </table>
      </li>
    </ul>
    <p>Например, материалу с параметрами offset 32 и shift 4 будут назначены цвета с индексами от 32 до 39.</p>
    <p>Папка docs/common/3d/materials_table содержит полный список материалов для всех миров и циклов.</p>
    <p>Следующие материалы - специальные и назначены только определенным полигонам, их не стоит назначать любым другим полигонам. * - натуральное число.</p>
    <ul>
      <li>zero_reserved</li>
      <li>center_of_mass</li>
      <li>wheel_*, wheel_steer_*, wheel_ghost_*, wheel_steer_ghost_*, wheel_ghost_steer_*</li>
      <li>attachment_point, attachment_point_*</li>
      <li>weapon_*</li>
    </ul>
  </li>
  <li>
    <p>У каждого *.m3d/*.a3d файла может быть кастомный набор цветов для материала "body". При помощи материала типа body_offset_*_shift_* можно указать offset и shift этого кастомного набора цветов.</p>
    <ul>
      <li>Нельзя указывать несколько наборов цветов для одной и той же модели. Например, если уже используется материал, допустим, body_offset_0_shift_0, то использование материалов, предположим, body_offset_1_shift_0 или body_offset_0_shift_1 приведет к ошибке.</li>
      <li>В одной модели могут быть и сам материал "body", и материал типа body_offset_*_shift_*.</li>
      <li>Только набор цветов главной модели используется при генерации *.m3d файла. Только набор цветов первой анимированной модели используется при генерации *.a3d файла. Материалы типа body_offset_*_shift_* можно использовать в других моделях, но это никак не повлияет на цвета конечных *.m3d/*.a3d файлов.</li>
    </ul>
  </li>
  <li>
    <p>Bound модель используется для расчета столкновений с ландшафтом.</p>
    <ul>
      <li>Модель должна иметь 4 вертекса на полигон.</li>
      <li>Модель должна быть закрыта.</li>
      <li>Назначение полигону обычных материалов не повлияет на поведение bound модели в игре.</li>
      <li>Чтобы создать новую bound модель, нужно создать куб с 4 полигонами на сторону, а затем сдвинуть вертексы так, чтобы обычная модель вписалась в получившуюся bound модель.</li>
      <li>Для bound модели главной модели мехоса есть специальная рекомендация. Вертексы 4 нижних полигонов должны быть на одном z уровне и им должен быть назначен материал "zero_reserved".</li>
    </ul>
  </li>
  <li>
    <p>Полигоны с материалом wheel_* в модели мехоса используются, чтобы определить, где расположены колеса и какими свойствами они обладают.</p>
    <ul>
      <li>У всех материалов колес должен быть порядковый номер в конце имени материала. Например: "wheel_1". Нумерация должна начинаться с 1. Номера нельзя пропускать. Если есть wheel_1 и wheel_3, то должен присутствовать и wheel_2. Нельзя назначать разным колесам один и тот же номер.</li>
      <li>Есть два свойства, которые можно назначить колесу: "steer" и "ghost". Эти свойства указываются с именем материала. Например, у рулевого призрачного колеса номер 1 имя материала будет "wheel_steer_ghost_1" или "wheel_ghost_steer_1". Все полигоны одного колеса должны иметь одинаковый набор свойств.</li>
      <li>Рулевые колеса влияют на способность мехоса поворачиваться, поэтому по крайней мере одно такое колесо должно присутствовать в любом мехосе, иначе его будет невозможно повернуть. При повороте в игре, все рулевые колеса тоже визуально поворачиваются.</li>
      <li>Призрачное свойство означает, что модель колеса будет убрана при конвертации в *.m3d, но у мехоса будет информация об этом колесе. Поэтому в игре мехос будет вести себя так, будто колесо есть.</li>
      <li>Нижняя точка первого колеса должна соответствовать нижней точке bound модели.</li>
    </ul>
  </li>
  <li>
    <p>Полигоны с материалом attachment_point являются частью модели точки крепления оружия.</p>
    <ul>
      <li>Эту модель нельзя изменять или скалировать, но передвигать ее можно.</li>
      <li>При конвертации *.obj в *.m3d все полигоны с этим материалом удаляются.</li>
    </ul>
    <ul>
      <li>
        <p>Когда является частью модели оружия, то указывает, где находится его точка крепления.</p>
        <ul>
          <li>Нельзя вращать.</li>
        </ul>
      </li>
      <li>
        <p>Когда является частью модели мехоса, указывает, где находятся слоты оружия.</p>
        <ul>
          <li>В конце имени материала должен быть номер оружейного слота. Например: "attachment_point_3".</li>
          <li>Максимум может быть только 3 оружейных слота.</li>
          <li>Можно повернуть только вокруг оси y, направление которой совпадает с направлением движения мехоса вперед.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>Полигоны с материалом weapon_* в модели мехоса показывают, где оружие будет расположено с текущим расположением оружейных слотов. Они удаляются при конвертации из *.obj в *.m3d и никак не влияют на финальную модель. Они сгруппированы с соответствующими точками крепления.</p>
  </li>
  <li>
    <p>Файл *.cfg генерируется для каждого *.m3d/*.a3d файла при конвертации *.m3d/*.a3d в *.obj. Этот конфигурационный файл используется при конвертации обратно в *.m3d/*.a3d.</p>
    <ul>
      <li>
        <p>В нем можно указать кастомный объем для каждой модели.</p>
        <ul>
          <li><p>Влияет на генерацию тензора инерции и цента масс.</p></li>
          <li>
            <p>Используется для определения массы.</p>
            <ul>
              <li>Участвует во многих расчетах.</li>
              <li>Участвует в определении силы тарана.</li>
            </ul>
          </li>
        </ul>
      </li>
      <li><p>В нем можно указать, какие модели должны использовать кастомный центр масс. Больше информации о центре масс ниже.</p></li>
      <li>
        <p>В нем можно указать кастомный тензор инерции для каждой модели.</p>
        <ul>
          <li>Используется во многих расчетах.</li>
        </ul>
      </li>
    </ul>
    <p>Эти конфигурационные файлы не стоит использовать в большинстве случаев, поскольку центр масс и тензор инерции генерируются автоматически.</p>
  </li>
  <li>
    <p>Полигоны с материалом center_of_mass являются частью модели центра масс.</p>
    <ul>
      <li>Эту модель нельзя менять, скалировать или поворачивать. Ее можно двигать.</li>
      <li>Генерируется при конвертации *.m3d в *.obj только тогда, когда опция extract_center_of_mass указана в конфигурационном файле.</li>
      <li>Используется только тогда, когда соответствующая опция указана в конфигурации *.m3d/*.a3d файла.</li>
      <li>Используется, чтобы вручную указать центр масс, который влияет на генерацию тензора инерции. Автоматическая генерация рекомендуется в большинстве случаев.</li>
    </ul>
  </li>
</ul>
